<?xml version="1.0" encoding="utf-8"?>
<dataController name="TrolleyLinePersonal" conflictDetection="overwriteChanges" label="Opexrq Trolley Item" handler="DatatecnixOfficerII.Rules.TrolleyLinePersonalBusinessRules" xmlns="urn:schemas-codeontime-com:data-aquarium">
  <commands>
    <command id="command1" type="Text">
      <text><![CDATA[
select
	`rq_trolley_item`.`rowid` `Rowid`
	,`rq_trolley_item`.`item_code` `ItemCode`
	,`item`.`sti_desc` `ItemStiDesc`
	,`rq_trolley_item`.`size_code` `SizeCode`
	,`rq_trolley_item`.`qty` `Qty`
	,`rq_trolley_item`.`comment_code` `CommentCode`
	,`comment`.`comment_desc` `CommentDesc`
	,`rq_trolley_item`.`line_value` `LineValue`
	,`rq_trolley_item`.`req_item_cost` `ReqItemCost`
	,`rq_trolley_item`.`UpdateStaffProfile` `UpdateStaffProfile`
	,`rq_trolley_item`.`staff_uid` `StaffUid`
	,`rq_trolley_item`.`type` `Type`
	,`rq_trolley_item`.`description` `Description`
	,`rq_trolley_item`.`additional_information` `AdditionalInformation`
	,`rq_trolley_item`.`gl_code` `glCode`
	,`rq_trolley_item`.`budget_code` `BudgetCode`
	,`rq_trolley_item`.`supplier` `Supplier`
from `opex`.`rq_trolley_item` `rq_trolley_item`
	left join `opex`.`st_item` `item` on `rq_trolley_item`.`item_code` = `item`.`item_code`
	left join `opex`.`rq_comms` `comment` on `rq_trolley_item`.`comment_code` = `comment`.`comment_code`
]]></text>
    </command>
    <command id="rowidIdentityCommand" type="Text" event="Inserted">
      <text><![CDATA[select @@identity]]></text>
      <output>
        <fieldOutput fieldName="Rowid" />
      </output>
    </command>
  </commands>
  <fields>
    <field name="Rowid" type="Int32" allowNulls="false" isPrimaryKey="true" label="Rowid" readOnly="true" />
    <field name="ItemCode" type="String" label="Item Code" length="16" showInSummary="true" causesCalculate="true">
      <items style="Lookup" dataController="ItemCataloguePersonal" dataValueField="ItemCode" dataTextField="ItemCode" dataView="grid1" copy="ItemStiDesc=StiDesc&#xD;&#xA;CommentCode=ChargeCode&#xD;&#xA;CommentDesc=ChargeCodeDescription&#xD;&#xA;&#xD;&#xA;" />
    </field>
    <field name="ItemStiDesc" type="String" readOnly="true" label="Item Description" length="75" />
    <field name="SizeCode" type="String" label="Size" length="20" showInSummary="true" contextFields="ItemCode=ItemCode" causesCalculate="true">
      <items style="Lookup" dataController="ItemSize" dataView="grid1" dataTextField="SizeCode" dataValueField="SizeCode" copy="ReqItemCost=Local_OPEXCost" />
    </field>
    <field name="Qty" type="Decimal" label="Qty" showInSummary="true" allowNulls="false" />
    <field name="CommentCode" type="String" label="Reason Code" length="3" allowNulls="false">
      <items style="Lookup" dataController="ReasonCodes" dataValueField="CommentCode" dataTextField="CommentCode" copy="CommentDesc=CommentDesc" />
    </field>
    <field name="CommentDesc" type="String" readOnly="true" label="Reason" length="20" />
    <field name="LineValue" type="Decimal" allowNulls="false" dataFormatString="C2" label="Total Cost" showInSummary="true" />
    <field name="ReqItemCost" type="Decimal" allowNulls="false" dataFormatString="C2" label="Item Cost" />
    <field name="UpdateStaffProfile" type="String" label="Update Staff Profile" length="1" />
    <field name="StaffUid" type="UInt32" allowNulls="false" label="Staff Uid" />
    <field name="Type" type="String" label="Type" length="1">
      <items style="DropDownList">
        <item value="S" text="Stock" />
        <item value="N" text="Non Stock" />
      </items>
    </field>
    <field name="Description" type="String" label="Description" length="500" />
    <field name="AdditionalInformation" type="String" label="Additional Information" length="200" />
    <field name="glCode" type="String" label="GL Code" length="12">
      <items style="Lookup" dataController="GlCodes" dataView="grid1" dataTextField="GlCode" dataValueField="GlCode" />
    </field>
    <field name="BudgetCode" type="String" label="Budget Code" length="8">
      <items style="Lookup" dataController="RqBudcd" dataView="grid1" dataTextField="BudgetCode" dataValueField="BudgetCode" />
    </field>
    <field name="Supplier" type="String" label="Supplier" length="20" />
    <field name="Local_StaffProfileSize" type="String" label="Local Staff Profile Size" length="20" />
    <field name="Local_Description" type="String" label="Description" computed="true" isVirtual="true" length="75">
      <formula>CASE 
WHEN `rq_trolley_item`.`type` = "N" THEN
`rq_trolley_item`.`description`
ELSE 
`item`.`sti_desc` 
END</formula>
    </field>
  </fields>
  <views>
    <view id="grid1" type="Grid" commandId="command1" label="Trolley Items">
      <headerText>This is a list of items in your Trolley, click the three dots next to the item code to modify</headerText>
      <dataFields>
        <dataField fieldName="StaffUid" columns="15" hidden="true" />
        <dataField fieldName="ItemCode" />
        <dataField fieldName="Local_Description" rows="5" />
        <dataField fieldName="SizeCode" columns="20" />
        <dataField fieldName="Qty" columns="15" />
        <dataField fieldName="ReqItemCost" columns="15" />
        <dataField fieldName="LineValue" columns="15" />
        <dataField fieldName="CommentCode" columns="3" hidden="true" />
        <dataField fieldName="CommentDesc" columns="20" />
        <dataField fieldName="UpdateStaffProfile" columns="1" hidden="true" />
        <dataField fieldName="Type" columns="1" hidden="true" />
        <dataField fieldName="Description" hidden="true" />
        <dataField fieldName="AdditionalInformation" />
        <dataField fieldName="glCode" columns="12" />
        <dataField fieldName="BudgetCode" columns="8" />
        <dataField fieldName="Supplier" columns="20" />
      </dataFields>
    </view>
    <view id="editForm1" type="Form" commandId="command1" label="Item in Trolley">
      <headerText>You can update this trolley item here</headerText>
      <categories>
        <category id="c1" flow="NewColumn">
          <description />
          <dataFields>
            <dataField fieldName="ItemCode" tag="lookup-details-hidden">
              <visibility>
                <expression test="[Type] == &quot;S&quot;" type="ClientScript" />
              </visibility>
            </dataField>
            <dataField fieldName="ItemStiDesc" rows="5" tag="lookup-details-hidden">
              <visibility>
                <expression test="[Type] == &quot;S&quot;" type="ClientScript" />
              </visibility>
            </dataField>
            <dataField fieldName="SizeCode" columns="20" tag="lookup-details-hidden">
              <visibility>
                <expression test="[Type] == &quot;S&quot;" type="ClientScript" />
              </visibility>
            </dataField>
            <dataField fieldName="Description">
              <visibility>
                <expression test="[Type] == &quot;N&quot;" type="ClientScript" />
              </visibility>
            </dataField>
            <dataField fieldName="Qty" columns="15" />
            <dataField fieldName="CommentCode" columns="3" tag="lookup-details-hidden" />
            <dataField fieldName="CommentDesc" columns="20" />
            <dataField fieldName="LineValue" columns="15" textMode="Static" hidden="true">
              <visibility>
                <expression test="[Type] == &quot;S&quot;" type="ClientScript" />
              </visibility>
            </dataField>
            <dataField fieldName="ReqItemCost" columns="15">
              <readOnly>
                <expression test="[Type] == &quot;S&quot;" type="ClientScript" />
              </readOnly>
            </dataField>
            <dataField fieldName="UpdateStaffProfile" columns="1" hidden="true" />
            <dataField fieldName="StaffUid" columns="15" hidden="true" />
            <dataField fieldName="Type" columns="1" hidden="true" />
            <dataField fieldName="AdditionalInformation" />
            <dataField fieldName="glCode" columns="12" />
            <dataField fieldName="BudgetCode" columns="8" />
            <dataField fieldName="Supplier" columns="20" />
            <dataField fieldName="Local_StaffProfileSize" columns="20" hidden="true" />
          </dataFields>
        </category>
      </categories>
    </view>
    <view id="createForm1" type="Form" commandId="command1" label="Add Item to Trolley" tags="material-icon-add-shopping-cart">
      <headerText>Add an item to your Trolley</headerText>
      <categories>
        <category id="c1" flow="NewColumn">
          <description />
          <dataFields>
            <dataField fieldName="ItemCode" />
            <dataField fieldName="ItemStiDesc" rows="5" />
            <dataField fieldName="SizeCode" columns="20" />
            <dataField fieldName="Qty" columns="15" />
            <dataField fieldName="CommentCode" columns="3" />
            <dataField fieldName="CommentDesc" columns="20" />
            <dataField fieldName="ReqItemCost" columns="15" textMode="Static" />
            <dataField fieldName="LineValue" columns="15" textMode="Static" />
            <dataField fieldName="UpdateStaffProfile" columns="1" textMode="Static" hidden="true" />
            <dataField fieldName="StaffUid" columns="15" textMode="Static" hidden="true" />
            <dataField fieldName="Type" columns="1" hidden="true" />
            <dataField fieldName="AdditionalInformation" />
            <dataField fieldName="glCode" columns="12" />
            <dataField fieldName="BudgetCode" columns="8" />
            <dataField fieldName="Supplier" columns="20" />
            <dataField fieldName="Local_StaffProfileSize" columns="20" hidden="true" />
          </dataFields>
        </category>
      </categories>
    </view>
    <view id="nonStockForm" type="Form" commandId="command1" label="Add Item to Trolley" tags="material-icon-add-shopping-cart">
      <headerText>Add an item to your Trolley</headerText>
      <categories>
        <category id="c1" headerText="Non Stock Item" flow="NewColumn">
          <description />
          <dataFields>
            <dataField fieldName="StaffUid" columns="15" textMode="Static" hidden="true" />
            <dataField fieldName="Type" columns="1" hidden="true" />
            <dataField fieldName="Description" />
            <dataField fieldName="Qty" columns="15" />
            <dataField fieldName="CommentCode" columns="3" />
            <dataField fieldName="CommentDesc" columns="20" />
            <dataField fieldName="glCode" columns="12" />
            <dataField fieldName="BudgetCode" columns="8" />
            <dataField fieldName="Supplier" columns="20" />
            <dataField fieldName="ReqItemCost" columns="15" />
            <dataField fieldName="AdditionalInformation" />
            <dataField fieldName="LineValue" columns="15" hidden="true" />
          </dataFields>
        </category>
      </categories>
    </view>
  </views>
  <actions>
    <actionGroup id="ag1" scope="Grid" flat="false">
      <action id="a1" commandName="Select" commandArgument="editForm1" headerText="More Information" />
      <action id="a2" commandName="Edit" commandArgument="editForm1" />
      <action id="a3" commandName="Delete" />
      <action id="a8" commandName="Duplicate" commandArgument="createForm1" />
      <action commandName="Email" id="a101" headerText="Ask A Question" description="Ask a Question ?" commandArgument="Ask" confirmation="_controller=OfficerEmailPrompt&#xD;&#xA;_title=Ask Question about an Item&#xD;&#xA;_width=500&#xD;&#xA;_view = PromptView" causesValidation="false" whenKeySelected="false" cssClass="glyphicon-question-sign" />
    </actionGroup>
    <actionGroup id="ag2" scope="Form">
      <action id="a1" commandName="Edit" />
      <action id="a2" commandName="Delete" />
      <action id="a3" commandName="Cancel" />
      <action id="a4" whenLastCommandName="Edit" commandName="Update" commandArgument="Save" />
      <action id="a5" whenLastCommandName="Edit" commandName="Cancel" />
      <action id="a6" whenLastCommandName="New" commandName="Insert" commandArgument="Save" />
      <action id="a7" whenLastCommandName="New" commandName="Insert" commandArgument="SaveAndNew" />
      <action id="a8" whenLastCommandName="New" commandName="Cancel" />
      <action id="a9" whenLastCommandName="Duplicate" commandName="Insert" />
      <action id="a10" whenLastCommandName="Duplicate" commandName="Cancel" />
      <action id="a13" whenLastCommandName="Insert" whenLastCommandArgument="Save" whenView="createForm1" commandName="Select" commandArgument="editForm1" whenClientScript="this.hasDetails()" />
      <action id="a14" whenLastCommandName="Insert" whenLastCommandArgument="SaveAndNew" commandName="New" commandArgument="createForm1" />
      <action commandName="Email" id="a101" headerText="Ask A Question" description="Ask a Question ?" commandArgument="Ask" confirmation="_controller=OfficerEmailPrompt&#xD;&#xA;_title=Ask Question about an Item&#xD;&#xA;_width=500&#xD;&#xA;_view = PromptView" causesValidation="false" whenKeySelected="false" cssClass="glyphicon-question-sign" />
    </actionGroup>
    <actionGroup id="ag3" scope="ActionBar" headerText="New" flat="true">
      <action id="a1" commandName="New" commandArgument="createForm1" cssClass="material-icon-add-shopping-cart" headerText="Add Item" />
      <action id="a100" commandName="New" commandArgument="nonStockForm" cssClass="material-icon-add-shopping-cart" headerText="Add Non Stock Item" />
    </actionGroup>
    <actionGroup id="ag4" scope="ActionBar" headerText="Edit/Delete" flat="true">
      <action id="a1" whenKeySelected="true" commandName="Edit" commandArgument="editForm1" cssClass="EditIcon" whenView="grid1" />
      <action id="a2" whenKeySelected="true" commandName="Delete" cssClass="DeleteIcon" whenView="grid1" />
    </actionGroup>
    <actionGroup id="ag6" scope="ActionBar" headerText="Record">
      <action id="a1" whenLastCommandName="Edit" commandName="Update" />
      <action id="a2" whenLastCommandName="Edit" commandName="Cancel" />
      <action id="a3" whenLastCommandName="New" commandName="Insert" />
      <action id="a4" whenLastCommandName="New" commandName="Cancel" />
    </actionGroup>
    <actionGroup id="ag8" scope="Row">
      <action id="a4" whenLastCommandName="Edit" commandName="Update" />
      <action id="a5" whenLastCommandName="Edit" commandName="Cancel" />
      <action id="a6" whenLastCommandName="New" commandName="Insert" />
      <action id="a7" whenLastCommandName="New" commandName="Cancel" />
    </actionGroup>
  </actions>
  <businessRules>
    <rule id="r100" commandName="Calculate" type="JavaScript" phase="Execute" name="CalculateLineCost"><![CDATA[	
  var q = [Qty];
  var ic = [ReqItemCost];
  [LineValue]=q * ic;
]]></rule>
    <rule id="r101" commandName="Calculate" type="Code" phase="Execute" name="GetSizeCost" />
    <rule id="r103" commandName="Insert|Update" type="Code" phase="Execute" name="HideLocalFields" />
    <rule id="r104" commandName="Insert|Update|Delete" type="Code" phase="After" name="RefreshMaster" />
    <rule id="r105" commandName="Email" type="Code" phase="After" name="ConfirmEmail" />
    <rule id="r106" commandName="Email" type="Email" phase="Execute" name="AskAQuestion" commandArgument="Ask"><![CDATA[From: "{Parameters_Forname} {Parameters_Surname}" {Parameters_OfficerEmail}
To: {Parameters_AskEmail}
Subject: {Parameters_Subject}
<html>
<body>
<p>
{Parameters_OfficerEmailHeader}
{Parameters_Message}
{Parameters_OfficerEmailFooter}
</p>
</body>
</html>]]></rule>
    <rule id="r107" commandName="New" type="Code" phase="Execute" name="GetDefaults" />
    <rule id="r102" commandName="Insert|Update" type="JavaScript" phase="Execute" name="UpdateStaffProfile"><![CDATA[// Check the size selected against the default one 
// and set the updateStaffProfile if it needs to be updated on Dispatch
// if no entry in staff profile it will create one
debugger;

var sizeCode = [SizeCode];
var profileSizeCode = [Local_StaffProfileSize];
var itemCode = [ItemCode];
var type =[Type]

if (type != "N")
{
  if (profileSizeCode == null)
{
  [UpdateStaffProfile] = "Y";
}

else if (sizeCode != profileSizeCode) 
{
  success = this.result.confirm(
    'Update Staff History for {0} change from {1} to {2} ? ',itemCode,profileSizeCode,sizeCode);
  if (success) {
    [UpdateStaffProfile] = "Y";
  }
}
}
]]></rule>
    <rule id="r108" commandName="Email" commandArgument="Ask" type="JavaScript" phase="After" name="AllowMessageDisplay"><![CDATA[this.preventDefault(); // #1585]]></rule>
    <rule id="r109" commandName="Insert|Update" view="nonStockForm|editForm1" type="JavaScript" phase="Before" name="CheckMandatoryFields"><![CDATA[debugger;
var fieldValue = [glCode];
var lineType = [Type];
if ((fieldValue == null)  && (lineType == "N")){
    // prevent the default action processing
    this.preventDefault();
    // set the focus on the field and display an error
    this.result.focus('glCode', 'GL Code Required');
  	return
}

    fieldValue = [BudgetCode];

if ((fieldValue == null)  && (lineType == "N")){
    // prevent the default action processing
    this.preventDefault();
    // set the focus on the field and display an error
    this.result.focus('BudgetCode', 'Budget Code Required');
  	return
}

    fieldValue = [Description];
if ((fieldValue == null)  && (lineType == "N")){
    // prevent the default action processing
    this.preventDefault();
    // set the focus on the field and display an error
    this.result.focus('Description', 'Description Required');
  	return
}

  var q = [Qty];
  var ic = [ReqItemCost];
  [LineValue]=q * ic;]]></rule>
  </businessRules>
</dataController>