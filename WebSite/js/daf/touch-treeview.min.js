/*!
* Touch UI - Tree View
* Copyright 2023-2024 Code On Time LLC; Licensed MIT; http://codeontime.com/license
*/
(function(){function c(n,t){var r,i;for(r in n)i=n[r],i.name=r,t&&(i.parent=t),i.nodes&&c(i.nodes,i)}function r(t){var i=n.treeView._navigating;return arguments.length&&i!=t&&(n.treeView._navigating=t,n.activePage(".app-treeview").css("visibility",t?"hidden":"")),i}function o(i,u){var s,e,l,f,a,w,h,c,v,y,p;if(typeof u=="string"){if(s=u.match(/^(.+?)\:\/\/(.+)$/),s)if(e=n.treeView.context(i),e.hierarchy.endsWith("."+s[1]))u=s[2];else{if(r(!1),e.eventName="navigate",e.path=u,l=$.Event("treeview.app",{treeView:e}),$(document).trigger(l),l.isDefaultPrevented())return;n.notify({text:`Unable to navigate to ${u}`,duration:"long"})}if(u.match(/^\./)){r(!1);n.propGrid.select(u.substring(1));return}u=u.split(/\//g);u.forEach((n,t)=>{n.match(/^\./)||(n=n.toLowerCase()),u[t]=decodeURIComponent(n)})}u.length&&(i.find(">li").each(function(){var n=$(this),t=n.data("nodeId");if(t===u[0])return f=n,!1}),f?(u._cleared||(f.closest(".app-treeview").find(".app-selected").removeClass("app-selected"),u._cleared=!0),u.splice(0,1),a=!0,u.length===1&&u[0].match(/^\./)?(w=n.dataView(),t.userVar(`${w._survey.context.instance}.navigate`,u[0])):u.length&&(a=!1,f.is(".app-collapsed")&&f.find(">.app-node>.app-toggle").trigger("vclick"),o(f.find("ul"),u)),a&&(h=f.data("navigating",!0).find(">.app-node").trigger("vclick"),f.removeData("navigating"),c=h.find(".app-anchor")[0],c&&(n.busy()||r()?c.scrollIntoView({block:"center",behavior:"instant"}):(v=t.clientRect(h.closest(".app-treeview")),y=t.clientRect(h),y.top>v.top&&y.bottom<v.bottom||n.pageShown(()=>{setTimeout(()=>{c.scrollIntoView({block:"center",behavior:"smooth"})})}))),r(!1))):(p=i.find(">.app-loading"),p.length?p.data("navigate",u):r(!1)))}function l(n,t){var i=null;return n&&(n.name==t&&(i=n),i||(n.nodes&&(i=n.nodes[t]),(!i||i.clone)&&(i=l(n.parent,t)))),i}function a(n){var t={};for(var i in n)t[i]=n[i];return t}function f(i,r,o,s){var k=null,d,lt,h,nt,ut,c,ft,et,at,w,ot,p,st,ht,ct,rt,b;for(d in r){if(lt=r[d],h=a(lt),h.clone&&(nt=l(h.parent,h.clone),nt)){nt=a(nt);for(ut in h)ut.match(/^(clone|name|parent)$/)||(nt[ut]=h[ut]);h=nt}c=o;try{c||h.iterate||!h.inherit||(k||(k=i.closest("li").data(),c={},c[k.nodeName]=k.nodeData,k=c),c=k);ft=t.eval(h.text,c)||t.prettyText(d,!0);et=h.id?t.eval(h.id,c):ft;(h.text==null||h.text===ft)&&(et=d);at=h.type;w=tt().attr({"data-type":at}).data({nodeName:d,nodeTemplate:h,nodeData:o,nodeId:encodeURIComponent(et.toLowerCase())});s?w.insertBefore(s):w.appendTo(i);var it=u("app-node").appendTo(w),pt=u("app-anchor").appendTo(it),vt=u("app-text").appendTo(it).text(ft);h.textMuted&&(ot=t.eval(h.textMuted,c),ot!=null&&u("app-muted").appendTo(it).text(ot));p=h.icon;p&&(p=t.eval(p,c),typeof p=="string"&&(st=p.match(/^material\-icon\-(.+)$/),st?iconElem=g("i","app-icon material-icon").text(st[1].replace(/\W/i,"_")).appendTo(vt):(p.match(/^[\w\-\_]+$/)||p.match(/material\-symbol/))&&it.addClass(p)));h.iterate&&o==null?(it.text("Loading..."),w.addClass("app-loading"),ht=i.closest("li"),(!ht.length||ht.is(".app-expanded"))&&y(d,h,i,w)):(ct=h.tooltip,typeof ct=="string"&&vt.attr("data-title",t.eval(ct,c)),rt=h.nodes,b=h.terminal,typeof b=="string"&&(b=t.eval(b,c)),rt?b&&(rt=null):b==null||b||(rt=[h]),rt&&(w.addClass(h.expanded?"app-expanded":"app-collapsed"),u("app-toggle").appendTo(it),f(e().appendTo(w),rt)))}catch(yt){n.notify({text:yt.message+": \n"+JSON.stringify(v(h),null,2),duration:"long"});throw yt;}}}function v(n){if(n.parent=null,n.nodes)for(var t in n.nodes)v(n.nodes[t]);return n}function y(t,i,r,u){var s=h("iterate",u),e;if(s.isDefaultPrevented()){u.remove();return}e=s.treeView.result;e instanceof Promise||(Array.isArray(e)||(e=[e]),e=Promise.resolve(e));e.then(n=>{var s={},e;s[t]=i;n.forEach(n=>{f(r,s,n,u)});e=u.data("navigate");u.remove();n.length||r.find(".app-node").length||r.closest("li").removeClass("app-expanded").find(".app-node .app-toggle").remove();e?o(r,e):k(r.parent())}).catch(t=>{n.notify({text:t.errors?t.errors[0].message:t.message,duration:"long"});throw t;})}function p(n,t,i){var r=n,f,o=t.match(/^(.+?)(\/|$)/),e,u,s;if(o){if(e=[],u=o[1].match(/^(\w+\:+)?(.+)$/),u[1]==="ancestor::")for(r=r.parent().closest("li");r.length;){if(f=r.data(),f.nodeName===u[2]){e.push(r);break}r=r.parent().closest("li")}else s=r.find("> ul > li"),r=null,s.each(function(){var n=$(this);f=n.data();((!u[1]||u[1]==="name::")&&f.nodeName===u[2]||u[1]&&f.nodeData&&f.nodeData[u[1].substring(0,u[1].length-1)]==u[2])&&e.push(n)});e.length&&(t=t.substring(o[0].length),e.forEach(n=>p(n,t,i)))}else i(r)}function w(n,t){var i=n.data();b({nodeElem:n,node:i.nodeTemplate,nodeName:i.nodeName,nodeData:i.nodeData},t,{related:!1})}function b(i,r,u){var f,s,c,o,v;if(u||(u={}),f=i,"nodeName"in i&&"nodeData"in i||(f=n.treeView.context(i)),i=f.nodeElem,s=i.data("replaceLock"),s||i.data("replaceLock",!0),u.related!==!1&&(f.node.related||[]).forEach(n=>{typeof n=="string"&&(n={path:n});var u=t.eval(n.path,r);p(i,u,n=>{var i=h("get",n),t=i.treeView.result;t instanceof Promise?t.then(t=>{w(n,t)}):w(n,t)})}),!s){c={};c[f.nodeName]=f.node;var y=i.find(".app-selected"),l=i.find("> .app-node"),a=e();n.treeView.createNodes(a,c,r);o=a.children().insertAfter(i).toggleClass("app-selected",i.is(".app-selected"));y.length?(v=o.data("nodeData"),i.data("nodeData",v),o.find("> .app-node").insertAfter(l),o.remove(),l.remove(),i.removeData("replaceLock")):i.remove()}}function h(i,r){var u=n.treeView.context(r),f,e;return(u.eventName=i,i==="select"&&u.treeView.data("trackSelection")&&t.userVar("treeview."+u.hierarchy,u.nodePath),f=$.Event("treeview.app",{treeView:u}),i==="iterate"&&u.node.when&&(e=t.eval(u.node.when,u.nodeData),!e))?(f.preventDefault(),f):($(document).trigger(f),f)}function k(n){var u,i;if(!r()){var o=t.clientRect(n),s=n.closest(".app-treeview"),f=t.clientRect(s),e=n.find("> ul"),h=t.clientRect(e);h.bottom>f.bottom&&(u="start",i=n,o.height<f.height&&(i=e,u="end"),i.length&&i[0].scrollIntoView({block:u,behavior:"smooth"}))}}var t=$app,s=t.input,n=t.touch,it=$(document),d=Web.DataViewResources,rt=d.Data.BooleanDefaultItems,ut=t.clientRect,i=t.html,ft=i.tag,et=i.div,ot=i.span,g=i.$tag,st=i.$p,nt=i.$div,u=i.$span,ht=i.$a,ct=i.$i,tt=i.$li,e=i.$ul;n.treeView=function(i,u,s){var l,h,a,v;(!s||(n.treeView.ready=!0,s(),i))&&(typeof i!="string"&&(u=i,i="show"),l=u.nodes,l instanceof Promise?l.then(t=>{u.nodes=t.nodes||{},n.treeView(i,u)}):(c(l),h=u.treeView,a=u.trackSelection,h?(l=u.nodes||h.data("nodes"),f(e().appendTo(h.empty()),l,null)):(h=nt("app-treeview app-has-scrollbars").attr({"data-hierarchy":u.type,tabindex:-1}).data({nodes:l,trackSelection:a}),f(e().appendTo(h),l,null),u.container&&h.appendTo(u.container),u.before&&h.insertBefore(u.before),u.after&&h.insertAfter(u.after)),h.toggleClass("app-treeview-noicons",u.icons===!1),v=u.path||(a?t.userVar("treeview."+u.type):null),v&&(r(!0),o(h.find("ul"),v))))};$(document).on("vclick",".app-toggle",n=>{var t,i;if(s.valid())return t=$(n.target).closest("li"),t.is(".app-expanded")?t.removeClass("app-expanded").addClass("app-collapsed"):(t.removeClass("app-collapsed").addClass("app-expanded"),i=!0,t.find("> ul > li.app-loading").each(function(){var n=$(this),t=n.data();y(t.nodeName,t.nodeTemplate,n.parent(),n);i=!1}),i&&k(t)),!1}).on("vclick",".app-treeview li span",i=>{var f=$(i.target),a,u,o,e,c,l;if(s.valid())return(u=f.closest("li"),u.is(".app-loading"))?!1:!f.is(".app-toggle")&&n.dblClick($(f))?(u.find("> .app-node .app-toggle").trigger("vclick"),!1):i.isDefaultPrevented()||u.is(".app-selected")?!1:(a=f.closest(".app-treeview"),u=f.closest("li"),a.find(".app-selected").removeClass("app-selected"),u.addClass("app-selected"),o=f.closest(".app-node"),e=null,r()||u.data("navigating")||(c=t.clientRect(o),l=t.clientRect(u.closest(".app-treeview")),c.bottom>l.bottom?e="end":c.top<l.top&&(e="start")),e&&o[0].scrollIntoView({block:e,behavior:"smooth"}),setTimeout(h,e?96:0,"select",u),!1)}).on("vclick","[data-studio-link]",n=>{var t,i,u;if(s.valid())return t=$(n.target),i=t.closest("[data-studio-link]").attr("data-studio-link"),i&&(u=t.closest(".app-propgrid").find("[data-hierarchy]"),r(!0),o(u.find(">ul"),i)),!1});n.treeView.data=function(t){var i;return t?Array.isArray(t)||(t=t.split(/\s*,\s*/g)):i={},n.activePage(".app-treeview .app-selected:first .app-node").parents("li").each(function(){var r=$(this),n=r.attr("data-type"),u=r.data("nodeData");if(t){if(t.forEach(t=>{t===n&&(i=u)}),i)return!1}else n&&(i[n]=u||{})}),i};n.treeView.context=function(t){t||(t=n.activePage(".app-treeview .app-selected:first"));for(var u=t.length?t.closest(".app-treeview"):n.activePage(".app-treeview"),e=u.attr("data-hierarchy"),o=t.data("nodeName"),s=t.data("nodeTemplate"),r,i=t,f=[];i.length;)f.splice(0,0,i.is(".app-loading")?"*":i.data("nodeId")),r==null&&(r=i.data("nodeData")),i=i.parent().closest("li");return{hierarchy:e,treeView:u,node:s,nodeName:o,nodePath:f.join("/"),nodeData:r,nodeElem:t}};n.treeView.createNodes=f;n.treeView.replaceNode=b})()